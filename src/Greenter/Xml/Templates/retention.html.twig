<?xml version="1.0" encoding="ISO-8859-1" standalone="no"?>
<Retention xmlns="urn:sunat:names:specification:ubl:peru:schema:xsd:Retention-1"
           xmlns:cac="urn:oasis:names:specification:ubl:schema:xsd:CommonAggregateComponents-2"
           xmlns:cbc="urn:oasis:names:specification:ubl:schema:xsd:CommonBasicComponents-2"
           xmlns:ds="http://www.w3.org/2000/09/xmldsig#"
           xmlns:ext="urn:oasis:names:specification:ubl:schema:xsd:CommonExtensionComponents-2"
           xmlns:sac="urn:sunat:names:specification:ubl:peru:schema:xsd:SunatAggregateComponents-1">
    <ext:UBLExtensions>
        <ext:UBLExtension>
            <ext:ExtensionContent></ext:ExtensionContent>
        </ext:UBLExtension>
    </ext:UBLExtensions>
    <cbc:UBLVersionID>2.0</cbc:UBLVersionID>
    <cbc:CustomizationID>1.0</cbc:CustomizationID>
    {% set emp = doc.company %}
    <cac:Signature>
        <cbc:ID>{{ emp.ruc }}</cbc:ID>
        <cbc:Note>GREENTER Builder</cbc:Note>
        <cac:SignatoryParty>
            <cac:PartyIdentification>
                <cbc:ID>{{ emp.ruc }}</cbc:ID>
            </cac:PartyIdentification>
            <cac:PartyName>
                <cbc:Name><![CDATA[{{ emp.nombreComercial|raw }}]]></cbc:Name>
            </cac:PartyName>
        </cac:SignatoryParty>
        <cac:DigitalSignatureAttachment>
            <cac:ExternalReference>
                <cbc:URI>#SIGN-GREEN</cbc:URI>
            </cac:ExternalReference>
        </cac:DigitalSignatureAttachment>
    </cac:Signature>
    <cbc:ID>{{ doc.serie }}-{{ doc.correlativo }}</cbc:ID>
    <cbc:IssueDate>{{ doc.fechaEmision|date('Y-m-d') }}</cbc:IssueDate>
    <cac:AgentParty>
        <cac:PartyIdentification>
            <cbc:ID schemeID="6">{{ emp.ruc }}</cbc:ID>
        </cac:PartyIdentification>
        <cac:PartyName>
            <cbc:Name><![CDATA[{{ emp.nombreComercial|raw }}]]></cbc:Name>
        </cac:PartyName>
        <cac:PostalAddress>
            <cbc:ID>{{ emp.address.ubigueo }}</cbc:ID>
            <cbc:StreetName>{{ emp.address.direccion }}</cbc:StreetName>
            <cac:Country>
                <cbc:IdentificationCode>{{ emp.address.codigoPais }}</cbc:IdentificationCode>
            </cac:Country>
        </cac:PostalAddress>
        <cac:PartyLegalEntity>
            <cbc:RegistrationName><![CDATA[{{ emp.razonSocial|raw }}]]></cbc:RegistrationName>
        </cac:PartyLegalEntity>
    </cac:AgentParty>
    <cac:ReceiverParty>
        <cac:PartyIdentification>
            <cbc:ID schemeID="{{ doc.proveedor.tipoDoc }}">{{ doc.proveedor.numDoc }}</cbc:ID>
        </cac:PartyIdentification>
        <cac:PartyLegalEntity>
            <cbc:RegistrationName><![CDATA[{{ doc.proveedor.rznSocial }}]]></cbc:RegistrationName>
        </cac:PartyLegalEntity>
    </cac:ReceiverParty>
    <sac:SUNATRetentionSystemCode>{{ doc.regimen }}</sac:SUNATRetentionSystemCode>
    <sac:SUNATRetentionPercent>{{ doc.tasa|number_format(2) }}</sac:SUNATRetentionPercent>
    {% if doc.observacion %}<cbc:Note><![CDATA[{{ doc.observacion|raw }}]]></cbc:Note>{% endif %}
    <cbc:TotalInvoiceAmount currencyID="PEN">{{ doc.impRetenido|number_format(2) }}</cbc:TotalInvoiceAmount>
    <sac:SUNATTotalPaid currencyID="PEN">{{ doc.impPagado|number_format(2) }}</sac:SUNATTotalPaid>
    {% for det in doc.details %}
    <sac:SUNATRetentionDocumentReference>
        <cbc:ID schemeID="{{ det.tipoDoc }}">{{ det.numDoc }}</cbc:ID>
        <cbc:IssueDate>{{ det.fechaEmision|date('Y-m-d') }}</cbc:IssueDate>
        <cbc:TotalInvoiceAmount currencyID="{{ det.moneda }}">{{ det.impTotal|number_format(2) }}</cbc:TotalInvoiceAmount>
        {% for pay in det.pagos %}
        <cac:Payment>
            <cbc:ID>{{ loop.index }}</cbc:ID>
            <cbc:PaidAmount currencyID="PEN">{{ pay.importe|number_format(2) }}</cbc:PaidAmount>
            <cbc:PaidDate>{{ pay.fecha|date('Y-m-d') }}</cbc:PaidDate>
        </cac:Payment>
        {% endfor %}
        <sac:SUNATRetentionInformation>
            <sac:SUNATRetentionAmount currencyID="PEN">{{ det.impRetenido|number_format(2) }}</sac:SUNATRetentionAmount>
            <sac:SUNATRetentionDate>{{ det.fechaRetencion|date('Y-m-d') }}</sac:SUNATRetentionDate>
            <sac:SUNATNetTotalPaid currencyID="PEN">{{ det.impPagar|number_format(2) }}</sac:SUNATNetTotalPaid>
            <cac:ExchangeRate>
                <cbc:SourceCurrencyCode>{{ det.tipoCambio.monedaRef }}</cbc:SourceCurrencyCode>
                <cbc:TargetCurrencyCode>{{ det.tipoCambio.monedaObj }}</cbc:TargetCurrencyCode>
                <cbc:CalculationRate>{{ det.tipoCambio.factor }}</cbc:CalculationRate>
                <cbc:Date>{{ det.tipoCambio.fecha|date('Y-m-d') }}</cbc:Date>
            </cac:ExchangeRate>
        </sac:SUNATRetentionInformation>
    </sac:SUNATRetentionDocumentReference>
    {% endfor %}
</Retention>